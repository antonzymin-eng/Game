name: Code Quality

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

env:
  CLANG_VERSION: 18
  CLANG_TIDY_FILE_LIMIT: 50  # Phase 1: 10, Phase 2: 50, Phase 3: 0 (all files)

jobs:
  # ClangFormat check - Verify code formatting
  format-check:
    name: ClangFormat Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Cache apt packages
        uses: actions/cache@v3
        with:
          path: /var/cache/apt
          key: ${{ runner.os }}-apt-clang-format-${{ env.CLANG_VERSION }}

      - name: Install ClangFormat
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format-${{ env.CLANG_VERSION }}

      - name: Check formatting
        run: |
          find src include -name "*.cpp" -o -name "*.h" | \
          xargs clang-format-${{ env.CLANG_VERSION }} --dry-run --Werror
        continue-on-error: true

      - name: Generate formatting diff
        if: failure()
        run: |
          find src include -name "*.cpp" -o -name "*.h" | \
          xargs clang-format-${{ env.CLANG_VERSION }} --dry-run --Werror 2>&1 | tee format-errors.txt
          echo "::warning::Code formatting issues found. Run 'clang-format -i <files>' to fix."

  # ClangTidy static analysis
  static-analysis:
    name: ClangTidy Static Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Cache apt packages
        uses: actions/cache@v3
        with:
          path: /var/cache/apt
          key: ${{ runner.os }}-apt-clang-tidy-${{ env.CLANG_VERSION }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang-tidy-${{ env.CLANG_VERSION }} \
            cmake \
            ninja-build \
            libsdl2-dev \
            libjsoncpp-dev

      - name: Configure CMake
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Run ClangTidy (Phase 2 - 50 files)
        run: |
          # Phase 2: Analyze 50 files with critical checks
          # Set CLANG_TIDY_FILE_LIMIT=0 for full codebase analysis
          FILE_LIMIT=${{ env.CLANG_TIDY_FILE_LIMIT }}
          if [ "$FILE_LIMIT" -eq 0 ]; then
            FILES=$(find src -name "*.cpp")
          else
            FILES=$(find src -name "*.cpp" | head -${FILE_LIMIT})
          fi
          echo "$FILES" | xargs clang-tidy-${{ env.CLANG_VERSION }} \
            -p build \
            --checks='-*,bugprone-*,cert-*' \
            --warnings-as-errors='' \
            2>&1 | tee clang-tidy-output.txt || true
          echo "::notice::Analyzed ${FILE_LIMIT} files (0 = all files)"
        continue-on-error: true

      - name: Upload ClangTidy results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: clang-tidy-results
          path: clang-tidy-output.txt

  # Documentation generation test
  docs-build:
    name: Documentation Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Cache apt packages
        uses: actions/cache@v3
        with:
          path: /var/cache/apt
          key: ${{ runner.os }}-apt-doxygen

      - name: Install Doxygen
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz

      - name: Generate documentation
        run: |
          doxygen Doxyfile

      - name: Check for Doxygen warnings
        run: |
          if grep -i "warning" doxygen.log 2>/dev/null; then
            echo "::warning::Doxygen generated warnings"
            cat doxygen.log
          fi

      - name: Upload documentation
        uses: actions/upload-artifact@v3
        with:
          name: api-documentation
          path: docs/api/html/

  # Compiler warnings check
  compiler-warnings:
    name: Compiler Warnings
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc, clang]
    steps:
      - uses: actions/checkout@v3

      - name: Cache apt packages
        uses: actions/cache@v3
        with:
          path: /var/cache/apt
          key: ${{ runner.os }}-apt-${{ matrix.compiler }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          if [ "${{ matrix.compiler }}" == "clang" ]; then
            sudo apt-get install -y clang-${{ env.CLANG_VERSION }}
          else
            sudo apt-get install -y g++-11
          fi
          sudo apt-get install -y cmake ninja-build libsdl2-dev libjsoncpp-dev

      - name: Configure CMake
        run: |
          if [ "${{ matrix.compiler }}" == "clang" ]; then
            export CC=clang-${{ env.CLANG_VERSION }}
            export CXX=clang++-${{ env.CLANG_VERSION }}
          else
            export CC=gcc-11
            export CXX=g++-11
          fi
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="-Wall -Wextra -Werror"

      - name: Build
        run: |
          cmake --build build 2>&1 | tee build-output.txt

      - name: Check for warnings
        run: |
          if grep -i "warning:" build-output.txt; then
            echo "::error::Build produced warnings"
            exit 1
          fi

  # EditorConfig validation
  editorconfig-check:
    name: EditorConfig Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install EditorConfig Checker
        env:
          EC_VERSION: 2.7.0
          # SHA256 checksum for ec-linux-amd64.tar.gz v2.7.0
          # Verify at: https://github.com/editorconfig-checker/editorconfig-checker/releases/tag/2.7.0
          EC_CHECKSUM: "1e8e01912db5b270f4517e1a16b8c22f1eb4ecdc9712e6c8e35a30b3b0b63db8"
        run: |
          wget https://github.com/editorconfig-checker/editorconfig-checker/releases/download/${EC_VERSION}/ec-linux-amd64.tar.gz
          echo "${EC_CHECKSUM}  ec-linux-amd64.tar.gz" | sha256sum -c -
          tar xzf ec-linux-amd64.tar.gz
          sudo mv bin/ec-linux-amd64 /usr/local/bin/editorconfig-checker
          sudo chmod +x /usr/local/bin/editorconfig-checker

      - name: Check EditorConfig compliance
        run: |
          editorconfig-checker -exclude ".git|build|vcpkg|\.clang-format|\.clang-tidy"

  # Documentation consistency check
  docs-consistency:
    name: Documentation Consistency
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Check for TODO items
        run: |
          echo "Checking for unresolved TODO items in documentation..."
          grep -r "TODO" docs/ *.md || echo "No TODOs found"

      - name: Check for broken links
        run: |
          echo "Checking for potential broken internal links..."
          # Check if referenced files exist
          for file in $(grep -ohr "\[.*\](.*\.md)" docs/ *.md | sed 's/.*(\(.*\.md\))/\1/' | sort -u); do
            if [ ! -f "$file" ] && [ ! -f "docs/$file" ]; then
              echo "::warning::Potentially broken link: $file"
            fi
          done

      - name: Verify style guide matches tools
        run: |
          echo "Verifying consistency between STYLE_GUIDE.md and tool configs..."
          # Check namespace indentation
          if grep -q "NamespaceIndentation: All" .clang-format; then
            echo "âœ“ Namespace indentation matches style guide"
          else
            echo "::error::Namespace indentation mismatch"
            exit 1
          fi
