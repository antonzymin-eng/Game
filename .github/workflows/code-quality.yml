name: Code Quality

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  # ClangFormat check - Verify code formatting
  format-check:
    name: ClangFormat Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install ClangFormat
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format-18

      - name: Check formatting
        run: |
          find src include -name "*.cpp" -o -name "*.h" | \
          xargs clang-format-18 --dry-run --Werror
        continue-on-error: true

      - name: Generate formatting diff
        if: failure()
        run: |
          find src include -name "*.cpp" -o -name "*.h" | \
          xargs clang-format-18 --dry-run --Werror 2>&1 | tee format-errors.txt
          echo "::warning::Code formatting issues found. Run 'clang-format -i <files>' to fix."

  # ClangTidy static analysis
  static-analysis:
    name: ClangTidy Static Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang-tidy-18 \
            cmake \
            ninja-build \
            libsdl2-dev \
            libjsoncpp-dev

      - name: Configure CMake
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Run ClangTidy (Phase 1 checks only)
        run: |
          # Only run critical checks for now
          find src -name "*.cpp" | head -10 | \
          xargs clang-tidy-18 \
            -p build \
            --checks='-*,bugprone-*,cert-*' \
            --warnings-as-errors='' \
            2>&1 | tee clang-tidy-output.txt || true
        continue-on-error: true

      - name: Upload ClangTidy results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: clang-tidy-results
          path: clang-tidy-output.txt

  # Documentation generation test
  docs-build:
    name: Documentation Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Doxygen
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz

      - name: Generate documentation
        run: |
          doxygen Doxyfile

      - name: Check for Doxygen warnings
        run: |
          if grep -i "warning" doxygen.log 2>/dev/null; then
            echo "::warning::Doxygen generated warnings"
            cat doxygen.log
          fi

      - name: Upload documentation
        uses: actions/upload-artifact@v3
        with:
          name: api-documentation
          path: docs/api/html/

  # Compiler warnings check
  compiler-warnings:
    name: Compiler Warnings
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc, clang]
    steps:
      - uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          if [ "${{ matrix.compiler }}" == "clang" ]; then
            sudo apt-get install -y clang-18
          else
            sudo apt-get install -y g++-11
          fi
          sudo apt-get install -y cmake ninja-build libsdl2-dev libjsoncpp-dev

      - name: Configure CMake
        run: |
          if [ "${{ matrix.compiler }}" == "clang" ]; then
            export CC=clang-18
            export CXX=clang++-18
          else
            export CC=gcc-11
            export CXX=g++-11
          fi
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="-Wall -Wextra -Werror"

      - name: Build
        run: |
          cmake --build build 2>&1 | tee build-output.txt

      - name: Check for warnings
        run: |
          if grep -i "warning:" build-output.txt; then
            echo "::error::Build produced warnings"
            exit 1
          fi

  # EditorConfig validation
  editorconfig-check:
    name: EditorConfig Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install EditorConfig Checker
        run: |
          wget https://github.com/editorconfig-checker/editorconfig-checker/releases/download/2.7.0/ec-linux-amd64.tar.gz
          tar xzf ec-linux-amd64.tar.gz
          sudo mv bin/ec-linux-amd64 /usr/local/bin/editorconfig-checker
          sudo chmod +x /usr/local/bin/editorconfig-checker

      - name: Check EditorConfig compliance
        run: |
          editorconfig-checker -exclude ".git|build|vcpkg|\.clang-format|\.clang-tidy"

  # Documentation consistency check
  docs-consistency:
    name: Documentation Consistency
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Check for TODO items
        run: |
          echo "Checking for unresolved TODO items in documentation..."
          grep -r "TODO" docs/ *.md || echo "No TODOs found"

      - name: Check for broken links
        run: |
          echo "Checking for potential broken internal links..."
          # Check if referenced files exist
          for file in $(grep -ohr "\[.*\](.*\.md)" docs/ *.md | sed 's/.*(\(.*\.md\))/\1/' | sort -u); do
            if [ ! -f "$file" ] && [ ! -f "docs/$file" ]; then
              echo "::warning::Potentially broken link: $file"
            fi
          done

      - name: Verify style guide matches tools
        run: |
          echo "Verifying consistency between STYLE_GUIDE.md and tool configs..."
          # Check namespace indentation
          if grep -q "NamespaceIndentation: All" .clang-format; then
            echo "âœ“ Namespace indentation matches style guide"
          else
            echo "::error::Namespace indentation mismatch"
            exit 1
          fi
